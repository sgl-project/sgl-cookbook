name: Schema CI

on:
  push:
    branches: [main]
    paths:
      - 'data/models/**'
      - 'data/schema/**'
      - 'data/scripts/**'
      - '.github/workflows/schema-ci.yml'
  pull_request:
    branches: [main]
    paths:
      - 'data/models/**'
      - 'data/schema/**'
      - 'data/scripts/**'
      - '.github/workflows/schema-ci.yml'

jobs:
  typescript-validation:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: data/schema

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: data/schema/package.json

      - name: Install dependencies
        run: npm install

      - name: Check generated model configs are up-to-date
        timeout-minutes: 2
        working-directory: .
        run: python3 data/scripts/compile_models.py --check

      - name: Validate YAML against TypeScript types
        timeout-minutes: 2
        run: npm test

  # Show diff of generated configs in PR
  config-diff:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          path: pr-branch

      - name: Checkout base branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.base.sha }}
          path: base-branch

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install PyYAML
        run: pip install pyyaml

      - name: Generate fresh configs from PR source
        working-directory: pr-branch
        run: |
          # Save current generated configs
          cp -r data/models/generated data/models/generated-from-pr

          # Regenerate from src
          python3 data/scripts/compile_models.py

          # Check if regenerated matches what's in PR
          if ! diff -rq data/models/generated data/models/generated-from-pr > /dev/null 2>&1; then
            echo "::warning::Generated configs in PR don't match what would be generated from src files"
            echo "REGENERATE_DIFF=true" >> $GITHUB_ENV
          fi

      - name: Show diff - PR generated vs regenerated from src
        if: env.REGENERATE_DIFF == 'true'
        working-directory: pr-branch
        run: |
          echo "## Generated configs in PR vs freshly regenerated from src"
          echo ""
          echo "The generated configs committed in this PR differ from what the compiler produces."
          echo "Please run \`python3 data/scripts/compile_models.py\` and commit the results."
          echo ""
          echo '```diff'
          diff -ru data/models/generated-from-pr data/models/generated || true
          echo '```'

      - name: Generate diff and job summary
        run: |
          # Generate diff
          diff -ru base-branch/data/models/generated pr-branch/data/models/generated > config-diff.patch || true

          echo "## Model Config Changes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check if there are changes
          if [ ! -s config-diff.patch ]; then
            echo "No changes to generated model configs." >> $GITHUB_STEP_SUMMARY
          else
            # Count changed files
            CHANGED_FILES=$(diff -rq base-branch/data/models/generated pr-branch/data/models/generated | wc -l | tr -d ' ')
            echo "**${CHANGED_FILES} file(s) changed** in generated model configs." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Add diff to job summary (truncate if too large)
            DIFF_SIZE=$(wc -c < config-diff.patch | tr -d ' ')
            MAX_SIZE=65000  # GitHub job summary has ~1MB limit, stay well under

            echo '```diff' >> $GITHUB_STEP_SUMMARY
            if [ "$DIFF_SIZE" -gt "$MAX_SIZE" ]; then
              head -c $MAX_SIZE config-diff.patch >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "... (truncated, diff too large)" >> $GITHUB_STEP_SUMMARY
            else
              cat config-diff.patch >> $GITHUB_STEP_SUMMARY
            fi
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
